<%- include('../partials/header', {title: 'Manage Inventory', user: user}) %>

<main>
    <div class="container">
        <div class="dashboard">
            <aside class="sidebar">
                <h3>Admin Menu</h3>
                <ul>
                    <li><a href="/admin/dashboard">Dashboard</a></li>
                    <li><a href="/admin/manage-inventory" class="active">Manage Inventory</a></li>
                </ul>
            </aside>
            
            <div class="main-content">
                <h2>Blood Stock Management</h2>

                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert error"><%= error %></div>
                <% } %>
                
                <% if (typeof success !== 'undefined' && success) { %>
                    <div class="alert success"><%= success %></div>
                <% } %>

                <!-- Current Blood Stock -->
                <div class="blood-stock">
                    <h3>Current Blood Stock</h3>
                    <div class="blood-group-grid">
                        <% const bloodGroups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] %>
                        <% bloodGroups.forEach(bg => { %>
                            <% const stock = bloodStock && bloodStock.find(s => s.bloodGroup === bg) || { units: 0 } %>
                            <div class="blood-group-card <%= stock.units < 5 ? 'low-stock' : '' %>">
                                <h4><%= bg %></h4>
                                <p class="units"><%= stock.units %> units</p>
                                <small>Last updated: <%= stock.lastUpdated ? new Date(stock.lastUpdated).toLocaleString() : 'Never' %></small>
                            </div>
                        <% }) %>
                    </div>
                </div>

                <!-- Update Inventory Form -->
                <div class="update-inventory">
                    <h3>Update Inventory</h3>
                    <form action="/admin/update-inventory" method="POST" class="inventory-form">
                        <div class="form-group">
                            <label for="bloodGroup">Blood Group</label>
                            <select name="bloodGroup" id="bloodGroup" required>
                                <option value="">Select Blood Group</option>
                                <% bloodGroups.forEach(bg => { %>
                                    <option value="<%= bg %>"><%= bg %></option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="units">Units</label>
                            <input type="number" name="units" id="units" min="1" required>
                        </div>

                        <div class="form-group">
                            <label for="action">Action</label>
                            <select name="action" id="action" required>
                                <option value="add">Add Units</option>
                                <option value="subtract">Remove Units</option>
                                <option value="set">Set Exact Value</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="description">Description (Optional)</label>
                            <textarea name="description" id="description" rows="2"></textarea>
                        </div>

                        <button type="submit" class="btn">Update Stock</button>
                    </form>
                </div>

                <!-- Recent Changes Log -->
                <div class="inventory-log">
                    <h3>Recent Inventory Changes</h3>
                    <% if (typeof recentLogs !== 'undefined' && recentLogs.length > 0) { %>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Blood Group</th>
                                    <th>Units</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Updated By</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% recentLogs.forEach(log => { %>
                                    <tr>
                                        <td><%= new Date(log.createdAt).toLocaleString() %></td>
                                        <td><%= log.bloodGroup %></td>
                                        <td><%= log.units >= 0 ? '+' + log.units : log.units %></td>
                                        <td><span class="badge <%= log.type %>"><%= log.type %></span></td>
                                        <td><%= log.description || '-' %></td>
                                        <td><%= log.relatedUser ? log.relatedUser.name : 'System' %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p>No recent changes</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</main>

<%- include('../partials/footer') %>
